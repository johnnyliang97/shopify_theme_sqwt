export class VariantSiblingRequestHandler{constructor(){this.fetchMap={}}static preloadImages=t=>{t.forEach(t=>{(new Image).src=t})};static preloadImagesAsync=t=>Promise.all(t.map(t=>new Promise((e,i)=>{const a=new Image;a.src=t,a.onload=()=>e(a),a.onerror=()=>i(new Error(`Failed to load image: ${t}`))})));static fetchVariantOptions=async t=>{const e=`/products/${t}?view=product-card-quick-add-options&section_id=product-card-quick-add-options`;try{const t=await fetch(e);return await t.text()}catch(t){return console.log(t),null}};static fetchMedia=async t=>{const e=`/products/${t}?view=color-change&section_id=product-card-media`;try{const t=await fetch(e);return await t.text()}catch(t){return console.log(t),null}};static fetchStaticImage=async t=>{const e=`/products/${t}?view=color-change&section_id=product-card-static-image`;try{const t=await fetch(e);return await t.text()}catch(t){return console.log(t),null}};static fetchPrice=async t=>{const e=`/products/${t}?view=color-change&section_id=product-card-price`;try{const t=await fetch(e);return await t.text()}catch(t){return console.log(t),null}};static waitForImageLoad=t=>new Promise((e,i)=>{t.onload=()=>e(t),t.onerror=()=>i(new Error(`Error loading image: ${t.src}`))})}if(!customElements.get("product-card-variant-siblings")){class t extends HTMLElement{constructor(){super(),this.form=this.querySelector("form"),this.card=this.closest("product-card"),this.card&&(this.mediaContainer=this.card.querySelector(".product-card-media-outer"),this.mediaElement=this.mediaContainer.querySelector("product-card-media"),this.mediaElement||(this.mediaElement=this.mediaContainer.querySelector(".product-card-media-static")),this.optionContainer=this.mediaElement?.querySelector(".product-card__quick-add-options"),this.mobileOptionsToggle=this.mediaElement?.querySelector("quick-add-mobile-toggle"),this.swatchInputs=this.querySelectorAll(".button--swatch input"),this.useFetching="true"===this.dataset.useFetching||0,this.hoverFetch="true"===this.dataset.hoverFetch||0,this.isDynamic="true"===this.card?.dataset.isDynamic||0,this.parentId=this.card?.dataset.parentId||null,this.noImageSwiper="true"===this.card?.dataset.noImageSwiper||0,this.isInfiniteScroll="true"===this.card?.dataset.isInfiniteScroll||0,this.rootElement=this.parentId?this.closest(`section#shopify-section-${this.parentId}`):null,this.noSetHeight="true"===this.card.dataset.noSetHeight||0,this.initialized=!1,this.isInfiniteScroll&&(this.noImageSwiper=!0,this.handleScroll()))}handleScroll(){const t=this.querySelector(".product__variant-options .swiper-wrapper");if(!t)return;const e=()=>{const e=t.scrollLeft,i=t.scrollWidth-t.clientWidth;t.classList.remove("scrollable-start","scrollable-end","not-scrollable-swatch"),t.scrollWidth<=t.clientWidth?t.classList.add("not-scrollable-swatch"):0===e?t.classList.add("scrollable-start"):Math.ceil(e)>=i&&t.classList.add("scrollable-end")};setTimeout(e,50),t.addEventListener("scroll",e)}connectedCallback(){1!=document.body.dataset.useSectionObserver&&this.initialize()}initialize=()=>{this.initialized||(this.initialized=!0,this.swiperDiv=this.querySelector(".swiper"),this.noImageSwiper||(this.imageSwiper=this.mediaElement?.querySelector(".swiper"),this.imageSwiperElement=this.mediaElement?.swiper),this.form.addEventListener("change",this.handleChange),this.hoverFetch&&this.card.addEventListener("mouseenter",this.handleHover),"complete"===document.readyState?this.initSwiper():document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{this.initSwiper()},1e3)}),1!=this.mediaElement?.outsideInit||this.noImageSwiper||this.mediaElement.initSwiper())};handleHover=async t=>{if(!(window.innerWidth<768||t.target.mediaData)){t.stopPropagation(),t.stopImmediatePropagation();for(const t of this.swatchInputs)this.attachSwatchImages(t)}};handleChange=async t=>{if(!t.target||"INPUT"!==t.target.tagName||!t.target.id)return;let e,i,a,s;const r=this.card;if(!r)return;if(this.noImageSwiper){if(s=this.getNoImageSwiperDomData(t.target),!s)return}else{if(s=this.getDomData(t.target),!s)return;e=s.activeSlideIndex}i=s.productHandle,a=s.productId;const n=r.querySelector(".product-card__link"),o=(n.href?String(n.href):"").split("/").pop(),c=n.href.replace(o,i);n.href=c;const d=await VariantSiblingRequestHandler.fetchVariantOptions(i),l=await VariantSiblingRequestHandler.fetchPrice(i);if(r.querySelector("#shopify-section-product-card-price").outerHTML=l,d){this.updateOptionsContent(d);const t=this.optionContainer.querySelector(".product-card__quick-add-mobile");t&&this.mobileOptionsToggle.attachAnchor(t)}if(_swat.collectionsApi.removeCollectionsButtons(),_swat.collectionsApi.initializeCollections(_swat,!1,window.Shopify.theme.schema_name),this.hoverFetch)this.handleHoverFetchClick(t,i,a,e);else if(this.useFetching)await this.updateMediaByFetching(i,e);else{const t=this.getSiblingImages(a);if(!t)return;this.noImageSwiper?await this.updateStaticImageContent(t[0]):await this.updateMediaImages(t,e)}};handleHoverFetchClick=async(t,e,i,a)=>{if(t.target.mediaReady)if(this.useFetching)this.updateMediaContent(t.target.mediaData,a);else{const e=this.getSiblingImages(i);if(!e)return;this.noImageSwiper?await this.updateStaticImageContent(t.target.mediaData):await this.updateMediaImages(e,a)}else this.mediaContainer.style.opacity=.5,await this.updateMediaByFetching(e,a),this.mediaContainer.style.opacity=1};getSiblingImages=t=>this.mediaDataMap?.get(t)||null;updateMediaByFetching=async(t,e)=>{if(this.mediaContainer.style.opacity=.5,this.noImageSwiper){const i=await VariantSiblingRequestHandler.fetchStaticImage(t);this.updateMediaContent(i,e)}else{const i=await VariantSiblingRequestHandler.fetchMedia(t);this.updateMediaContent(i,e)}this.mediaContainer.style.opacity=1};updateMediaImages=async(t,e)=>{};updateMediaContent=(t,e)=>{if(this.imageSwiper?.style.height||this.noSetHeight||this.noImageSwiper||this.isDynamic||this.setImageSwiperHeight(),this.noImageSwiper)this.mediaElement.innerHTML=t,document.dispatchEvent(new CustomEvent("swym:collections-loaded"));else{const i=(new DOMParser).parseFromString(t,"text/html").querySelector(".swiper-wrapper"),a=this.imageSwiper.querySelector(".swiper-wrapper");a&&i&&(a.innerHTML=i.innerHTML),this.mediaElement.swiper&&this.mediaElement.swiper.slideTo(e)}};updateStaticImageContent=async t=>{const e=this.mediaElement;e&&(this.mediaContainer.style.opacity=.5,VariantSiblingRequestHandler.preloadImagesAsync([t.desktop,t.mobile]).then(()=>{const i=e.querySelector("img"),a=e.querySelector("source");a&&(a.srcset=t.desktop),i&&(i.src=t.mobile),this.mediaContainer.style.opacity=1}))};setImageSwiperHeight=()=>this.imageSwiper.style.height=this.imageSwiper.getBoundingClientRect().height+"px";attachSwatchImages=async t=>{const{productHandle:e}=this.getDomData(t);if(this.noImageSwiper){const i=await VariantSiblingRequestHandler.fetchStaticImage(e);t.mediaData=i}else{const i=await VariantSiblingRequestHandler.fetchMedia(e);t.mediaData=i}t.mediaReady=!0};getDomData=t=>{if(!this.card)return;const e=this.mediaContainer.querySelector("product-card-media")?.swiper,i=e?e.activeIndex:0,a=t.id.split("-sibling-")[1].split("-id-");return{activeSlideIndex:i,productHandle:a[0],productId:a[1]}};getNoImageSwiperDomData=t=>{const e=this.mediaContainer.querySelector("product-card-media-static"),i=t.id.split("-sibling-")[1].split("-id-");return{imageContainer:e,productHandle:i[0],productId:i[1]}};updateOptionsContent=t=>this.optionContainer.innerHTML=t;initSwiper=()=>{if(this.isInfiniteScroll)return;if(!this.swiperDiv)return;const t=this.swiperDiv?.querySelector(".swiper-wrapper"),e=t.children.length,i=getComputedStyle(document.documentElement),a=parseInt(i.getPropertyValue("--product-card-option-button-size"))||16,s=parseInt(i.getPropertyValue("--product-card-option-button-size-mobile"))||22,r=window.innerWidth>989?a:s;e<(window.innerWidth>989?Math.floor(200/r):Math.floor(150/r))||(this.swiper=new Swiper(this.swiperDiv,{cssMode:!0,slidesPerView:"auto",watchSlidesProgress:!0,resistanceRatio:.2,watchSlidesVisibility:!0,spaceBetween:8,nested:!0,touchMoveStopPropagation:!0,touchMovePreventDefault:!0}))}}customElements.define("product-card-variant-siblings",t)}